<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>下剋上数学</title>

<style>
body { font-family:"Yu Mincho", serif; background:#e9ecef; margin:0; padding:30px 0; }
.paper { width:800px; margin:auto; background:#fff; padding:40px 50px; box-shadow:0 0 10px rgba(0,0,0,0.15); }
h1 { text-align:center; letter-spacing:4px; margin-bottom:20px; }
.info { display:flex; justify-content:space-between; margin-bottom:5px; }
.name-input { border:none; border-bottom:2px solid #000; width:200px; font-size:18px; padding:4px; }
.section { margin-top:25px; }
.section-title { font-weight:bold; margin-bottom:10px; }
.question { margin:10px 0; display:flex; align-items:center; }
.label { width:140px; }
input.answer, input.range-answer {
  border:none; border-bottom:2px solid #000;
  width:200px; font-size:18px; padding:4px; text-align:center;
}
.result { margin-left:15px; font-weight:bold; font-size:18px; }
.buttons { text-align:center; margin-top:30px; }
button { padding:10px 25px; font-size:16px; }
#score { text-align:right; font-size:20px; font-weight:bold; }
.explanation { font-size:14px; margin-bottom:15px; }
</style>
</head>

<body>
<div class="paper">
<h1>下 剋 上 数 学</h1>

<div class="info">
<div>氏名：<input id="studentName" name="studentName" class="name-input"></div>
<div id="score">得点：</div>
</div>

<div class="explanation">
数字・文字・記号はすべて半角で入力すること。<br>
採点は全て入力が終わったらすること。採点された解答は製作者に送られる。
</div>

<!-- ===== 大問1 ===== -->
<div class="section">
<div class="section-title">大問1（各5点）</div>

<div class="question"><div class="label">(1)　B野田</div>
<input class="answer" id="q1_1" name="q1_1"><span class="result" id="r1_1"></span></div>

<div class="question"><div class="label">(2)　D大黒</div>
<input class="answer" id="q1_2" name="q1_2"><span class="result" id="r1_2"></span></div>

<div class="question"><div class="label">(3)　C水野</div>
<input class="answer" id="q1_3" name="q1_3"><span class="result" id="r1_3"></span></div>

<div class="question"><div class="label">(4)　C水野</div>
<input class="answer" id="q1_4" name="q1_4"><span class="result" id="r1_4"></span></div>

<div class="question"><div class="label">(5)　A松本</div>
<input class="range-answer" id="q1_5_min" name="q1_5_min"> ≤ S <
<input class="range-answer" id="q1_5_max" name="q1_5_max">
<span class="result" id="r1_5"></span>
</div>
</div>

<!-- ===== 大問2 ===== -->
<div class="section">
<div class="section-title">大問2　D大黒</div>

<div class="question"><div class="label">(1)　7点</div>
<input class="answer" id="q2_1" name="q2_1"><span class="result" id="r2_1"></span></div>

<div class="question"><div class="label">(2)　8点</div>
<input class="answer" id="q2_2" name="q2_2"><span class="result" id="r2_2"></span></div>
</div>

<!-- ===== 大問3 ===== -->
<div class="section">
<div class="section-title">大問3　15点　C野々部</div>

<div class="question">
<input class="answer" id="q3" name="q3"><span class="result" id="r3"></span>
</div>
</div>

<!-- ===== 大問4 ===== -->
<div class="section">
<div class="section-title">大問4　完答15点　A松本</div>

<div class="question"><div class="label">最大値</div>
<input class="range-answer" id="q4_max" name="q4_max"></div>

<div class="question"><div class="label">最小値</div>
<input class="range-answer" id="q4_min" name="q4_min">
<span class="result" id="r4"></span></div>
</div>

<!-- ===== 大問5 ===== -->
<div class="section">
<div class="section-title">大問5　B野田</div>

<div class="question"><div class="label">(1)　8点</div>
<input class="answer" id="q5_1" name="q5_1"><span class="result" id="r5_1"></span></div>

<div class="question"><div class="label">(2)　7点</div>
<input class="answer" id="q5_2" name="q5_2"><span class="result" id="r5_2"></span></div>
</div>

<!-- ===== 大問6 ===== -->
<div class="section">
<div class="section-title">大問6　15点　C野々部</div>

<div class="question">
<input class="answer" id="q6" name="q6"><span class="result" id="r6"></span>
</div>
</div>

<!-- 感想 -->
<div class="section">
<div class="section-title">感想</div>
<input id="comment" name="comment" class="answer">
</div>

<div class="buttons">
<button onclick="grade()">採点</button>
</div>

</div>

<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbwB3YoXRdlNaHM8LZBCimInsxYqWSmAsfh5qijN0gD4ntmvjLLqTRmFzReEV0-evSSn/exec";

const answers={
q1_1:{value:"3π/4",points:5},
q1_2:{value:"10946",points:5},
q1_3:{value:"8/7",points:5},
q1_4:{value:"0",points:5},
q1_5:{value:["28","77"],points:5},
q2_1:{value:"8/3",points:8},
q2_2:{value:"3",points:7},
q3:{value:"√5",points:15},
q4:{value:["2000/3","500/3"],points:15},
q5_1:{value:"700n",points:8},
q5_2:{value:"700n+65",points:7},
q6:{value:"|sv-tu|^n",points:15}
};

function normalize(s){
  return (s||"")
    .replace(/\s+/g,"")     // 空白削除
    .replace(/×/g,"*")      // ×→*
    .replace(/[()]/g,"");   // ()無視
  }
  function equalAbsolute(a,b){
  a = normalize(a);
  b = normalize(b);

  // | | を外す（^n も保持）
  a = a.replace(/^\|(.+)\|(\^.*)?$/,"$1$2");
  b = b.replace(/^\|(.+)\|(\^.*)?$/,"$1$2");

  if(a===b) return true;

  // A-B → B-A に並び替え
  const swapDiff = x=>{
    const m = x.match(/^(.+)-(.+?)(\^.*)?$/);
    if(!m) return x;
    return m[2]+"-"+m[1]+(m[3]||"");
  };

  // 全体に -1 を掛ける（符号反転）
  const neg = x=>{
    return x
      .replace(/\+/g,"@")
      .replace(/-/g,"+")
      .replace(/@/g,"-");
  };

  // 積の順序入替（tu ⇔ ut）
  // 各項の文字の並びをアルファベット順に揃える（sv → sv, vs → sv）
const normalizeProduct = expr => {

  return expr.replace(/[a-z]+/gi, term => {
    return term.split("").sort().join("");
  });

};

  // 数学的に同じ可能性を全部比較
  // まず掛け算を標準化
a = normalizeProduct(a);
b = normalizeProduct(b);

const patterns = [
  a,
  neg(a),
  swapDiff(a),
  neg(swapDiff(a))
].map(normalizeProduct);
  return patterns.includes(b);
  }
function grade(){
let score=0,total=0;

for(const id in answers){
total+=answers[id].points;

if(id==="q1_5"){
if(normalize(q1_5_min.value)===answers[id].value[0] &&
   normalize(q1_5_max.value)===answers[id].value[1]){
r1_5.textContent="○"; score+=5;
}else r1_5.textContent="×";
continue;
}

if(id==="q4"){
if(normalize(q4_max.value)===answers[id].value[0] &&
   normalize(q4_min.value)===answers[id].value[1]){
r4.textContent="○"; score+=15;
}else r4.textContent="×";
continue;
}

const input=document.getElementById(id).value;
const res=document.getElementById("r"+id.slice(1));

if(id==="q6"){
  if(equalAbsolute(input,answers[id].value)){
    res.textContent="○"; score+=answers[id].points;
  }else res.textContent="×";
}else{
  if(normalize(input)===answers[id].value){
    res.textContent="○"; score+=answers[id].points;
  }else res.textContent="×";
  }
}

document.getElementById("score").textContent=`得点：${score} / ${total}`;
send(score,total);
}

function send(score,total){

  const fd = new FormData();

  // 基本情報
  fd.append("name", studentName.value);
  fd.append("time", new Date().toLocaleString());
  fd.append("score", score);
  fd.append("total", total);
  fd.append("comment", comment.value);

  // ▼答案を全部送信（これが今回追加）
  fd.append("q1_1", q1_1.value);
  fd.append("q1_2", q1_2.value);
  fd.append("q1_3", q1_3.value);
  fd.append("q1_4", q1_4.value);
  fd.append("q1_5_min", q1_5_min.value);
  fd.append("q1_5_max", q1_5_max.value);

  fd.append("q2_1", q2_1.value);
  fd.append("q2_2", q2_2.value);

  fd.append("q3", q3.value);

  fd.append("q4_max", q4_max.value);
  fd.append("q4_min", q4_min.value);

  fd.append("q5_1", q5_1.value);
  fd.append("q5_2", q5_2.value);

  fd.append("q6", q6.value);

  fetch(GAS_URL, { method:"POST", body:fd });
}
</script>
</body>
</html>
