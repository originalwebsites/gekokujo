<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>下剋上数学</title>
<style>
body { font-family:"Yu Mincho", serif; background:#e9ecef; margin:0; padding:30px 0; }
.paper { width:800px; margin:auto; background:#fff; padding:40px 50px; box-shadow:0 0 10px rgba(0,0,0,0.15); }
h1 { text-align:center; letter-spacing:4px; margin-bottom:20px; }
.info { display:flex; justify-content:space-between; margin-bottom:5px; }
.info div { width:45%; }
.name-input { border:none; border-bottom:2px solid #000; width:200px; font-size:18px; padding:4px; }
.section { margin-top:20px; }
.section-title { font-weight:bold; margin-bottom:10px; }
.question { margin:10px 0; display:flex; align-items:center; }
.label { width:80px; }
input.answer { border:none; border-bottom:2px solid #000; width:220px; font-size:18px; padding:4px; text-align:center; height:32px; }
.range-label { margin:0 5px; font-size:18px; display:flex; align-items:center; height:32px; }
.result { margin-left:15px; font-weight:bold; font-size:18px; }
.buttons { text-align:center; margin-top:30px; }
button { padding:8px 20px; margin:0 10px; font-size:15px; }
#score { text-align:right; font-size:20px; font-weight:bold; }
.explanation { font-size:14px; margin-bottom:15px; }
</style>
</head>

<body>
<div class="paper">
<h1>下 剋 上 数 学</h1>

<div class="info">
  <div>氏名：<input id="studentName" class="name-input"></div>
  <div id="score">得点：</div>
</div>

<div class="explanation">
入力された内容は採点されると即時に製作者に送信されます。また、数字、文字、記号は全て半角で打つこと。<br>
答える値が複数ある場合（例:範囲を答える問題、最大値最小値、解が2つある問題など）は問題文で聞かれている順に「,」で区切って答えてください。
</div>

<!-- ===== 問題構成 ===== -->
<div class="section">
  <div class="section-title">大問1</div>
  <div class="question"><div class="label">(1)</div><input class="answer" id="q1_1"><span class="result" id="r1_1"></span></div>
  <div class="question"><div class="label">(2)</div><input class="answer" id="q1_2"><span class="result" id="r1_2"></span></div>
  <div class="question"><div class="label">(3)</div><input class="answer" id="q1_3"><span class="result" id="r1_3"></span></div>
  <div class="question"><div class="label">(4)</div><input class="answer" id="q1_4"><span class="result" id="r1_4"></span></div>
  <!-- 大問1(5) 範囲入力 -->
  <div class="question">
    <div class="label">(5)</div>
    <input class="answer" id="q1_5_min" placeholder="　">
    <span class="range-label">≤S<</span>
    <input class="answer" id="q1_5_max" placeholder="　">
    <span class="result" id="r1_5"></span>
  </div>
</div>

<div class="section">
  <div class="section-title">大問2</div>
  <div class="question"><div class="label">(1)</div><input class="answer" id="q2_1"><span class="result" id="r2_1"></span></div>
  <div class="question"><div class="label">(2)</div><input class="answer" id="q2_2"><span class="result" id="r2_2"></span></div>
</div>

<div class="section">
  <div class="section-title">大問3</div>
  <div class="question"><div class="label">解答</div><input class="answer" id="q3"><span class="result" id="r3"></span></div>
</div>

<div class="section">
  <div class="section-title">大問4</div>
  <div class="question"><div class="label">解答</div><input class="answer" id="q4"><span class="result" id="r4"></span></div>
</div>

<div class="section">
  <div class="section-title">大問5</div>
  <div class="question"><div class="label">(1)</div><input class="answer" id="q5_1"><span class="result" id="r5_1"></span></div>
  <div class="question"><div class="label">(2)</div><input class="answer" id="q5_2"><span class="result" id="r5_2"></span></div>
</div>

<div class="section">
  <div class="section-title">大問6</div>
  <div class="question"><div class="label">解答</div><input class="answer" id="q6"><span class="result" id="r6"></span></div>
</div>

<!-- ===== 感想欄 ===== -->
<div class="section">
  <div class="section-title">感想</div>
  <input id="comment" class="answer" placeholder="テストの感想を書いてください">
</div>

<div class="buttons">
  <button onclick="grade()">採点</button>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwB3YoXRdlNaHM8LZBCimInsxYqWSmAsfh5qijN0gD4ntmvjLLqTRmFzReEV0-evSSn/exec";

const answers = {
  "q1_1": { value:"π/4", points:5 },
  "q1_2": { value:"10946", points:5 },
  "q1_3": { value:"8/7", points:5 },
  "q1_4": { value:"0", points:5 },
  "q1_5": { value:["28","77"], points:5 }, // 範囲問題
  "q2_1": { value:"8/3", points:5 },
  "q2_2": { value:"3", points:10 },
  "q3":   { value:"√5", points:15 },
  "q4":   { value:["2000/3","500/3"], points:15 },
  "q5_1": { value:"700n", points:8 },
  "q5_2": { value:"700n+65", points:7 },
  "q6":   { value:"|sv-tu|^n", points:15 }
};

function normalize(str){
  return (str||"")
           .replace(/[０-９]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0))
           .replace(/\s+/g,"")
           .replace(/<=/g,'≤') // 半角<=も全角に統一
           .trim();
}

// 絶対値内の順序と符号を無視してアルファベット順に整列
function canonical(expr){
  expr = normalize(expr);

  // 絶対値内を正規化
  expr = expr.replace(/\|([^\|]+)\|/g,(match,p1)=>{
    let letters = p1.replace(/[^a-zA-Z]/g,'').split('');
    letters.sort();
    return '|' + letters.join('') + '|';
  });

  // 外側の + と * の交換法則
  if(expr.includes('+')) return expr.split('+').map(s=>s.trim()).sort().join('+');
  if(expr.includes('*')) return expr.split('*').map(s=>s.trim()).sort().join('*');

  return expr;
}

function grade(){
  let score=0;
  let total=0;

  for(const id in answers){
    const result=document.getElementById("r"+id.slice(1));
    const correct=answers[id];
    total += correct.points;

    // 範囲問題の判定
    if(id==="q1_5"){
      const min = normalize(document.getElementById("q1_5_min").value);
      const max = normalize(document.getElementById("q1_5_max").value);
      if(min===correct.value[0] && max===correct.value[1]){
        result.textContent="○";
        score += correct.points;
      } else {
        result.textContent="×";
      }
      continue;
    }

    const input=document.getElementById(id).value;
    if(canonical(input) === canonical(correct.value)){
      result.textContent="○";
      score += correct.points;
    } else {
      result.textContent="×";
    }
  }

  document.getElementById("score").textContent = `得点：${score} / ${total}`;
  sendToSheet(score,total);
}

function sendToSheet(score,total){
  const data = {
    name: document.getElementById("studentName").value,
    comment: document.getElementById("comment").value,
    timestamp: new Date().toLocaleString(),
    score, total,
    answers: {}
  };
  for(const id in answers){
    if(id==="q1_5"){
      data.answers[id] = document.getElementById("q1_5_min").value + "≤S<" + document.getElementById("q1_5_max").value;
    } else {
      data.answers[id] = document.getElementById(id).value;
    }
  }

  fetch(GAS_URL, { method:"POST", mode:"no-cors", body:JSON.stringify(data) });
}
</script>
</body>
</html>
